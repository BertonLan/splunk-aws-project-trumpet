            {
                "AWSTemplateFormatVersion": "2010-09-09",
                "Parameters": {
                    "CloudWatchSplunkHttpEventCollectorToken": {
                        "Type": "String",
                        "Description": "The enabled HEC token on the Splunk environment for the aws:cloudwatch sourcetype. (format - 12345678-qwer-asdf-zxcv-123456789qwe)"
                    },
                    "ConfigNotificationSplunkHttpEventCollectorToken": {
                        "Type": "String",
                        "Description": "The enabled HEC token on the Splunk environment for the aws:config:notification sourcetype. (format - 12345678-qwer-asdf-zxcv-123456789qwe)"
                    },
                    "CloudTrailSplunkHttpEventCollectorToken": {
                        "Type": "String",
                        "Description": "The enabled HEC token on the Splunk environment for the aws:cloudtrail sourcetype. (format - 12345678-qwer-asdf-zxcv-123456789qwe)"
                    },
                    "SplunkHttpEventCollectorURL": {
                        "Type": "String",
                        "Description": "The HEC endpoint server and port (default 8088) of the the Splunk environment which will receive AWS data. (format - https://server:port/services/collector)"
                    },
                    "ConfigSplunkHttpEventCollectorToken": {
                        "Type": "String",
                        "Description": "The enabled HEC token on the Splunk environment for the aws:config sourcetype. (format - 12345678-qwer-asdf-zxcv-123456789qwe)"
                    }
                },
                "Description": "Template for AWS data ingest into Splunk using AWS Kinesis Firehose and AWS Lambda.",
                "Mappings": {
                  "BucketMap": {
                    "us-east-1": { "BucketName": "trumpet-splunk-us-east-1" },
                    "us-east-2": { "BucketName": "trumpet-splunk-us-east-2" },
                    "us-west-1": { "BucketName": "trumpet-splunk-us-west-1" },
                    "us-west-2": { "BucketName": "trumpet-splunk-us-west-2" },
                    "ca-central-1": { "BucketName": "trumpet-splunk-ca-central-1" },
                    "eu-central-1" : { "BucketName": "trumpet-splunk-eu-central-1" },
                    "eu-west-1": { "BucketName": "trumpet-splunk-eu-west-1" },
                    "eu-west-2": { "BucketName": "trumpet-splunk-eu-west-2" },
                    "eu-west-3": { "BucketName": "trumpet-splunk-eu-west-3" },
                    "ap-northeast-1": { "BucketName": "trumpet-splunk-ap-northeast-1" },
                    "ap-northeast-2": { "BucketName": "trumpet-splunk-ap-northeast-2" },
                    "ap-northeast-3": { "BucketName": "trumpet-splunk-ap-northeast-3" },
                    "ap-southeast-1": { "BucketName": "trumpet-splunk-ap-southeast-1" },
                    "ap-southeast-2": { "BucketName": "trumpet-splunk-ap-southeast-1" },
                    "ap-south-1": { "BucketName": "trumpet-splunk-ap-south-1" },
                    "sa-east-1": { "BucketName": "trumpet-splunk-sa-east-1" }
                  }
                },
                "Resources": {
                    "ConfigurationRecorderSanitizationLambdaExecutionRole": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "Policies": [
                                {
                                    "PolicyName": "root",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "iam:PassRole"
                                                ],
                                                "Resource": [
                                                    {
                                                        "Fn::GetAtt": [
                                                            "BackingLambdaExecutionConfigLogProcessor",
                                                            "Arn"
                                                        ]
                                                    }
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "logs:CreateLogGroup",
                                                    "logs:CreateLogStream",
                                                    "logs:PutLogEvents"
                                                ],
                                                "Resource": "arn:aws:logs:*:*:*",
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "config:DescribeConfigurationRecorders",
                                                    "config:DescribeDeliveryChannels",
                                                    "config:PutConfigurationRecorder",
                                                    "config:StartConfigurationRecorder",
                                                    "config:PutDeliveryChannel",
                                                    "config:DescribeConfigurationRecorderStatus",
                                                    "config:DeleteConfigurationRecorder",
                                                    "config:DeleteDeliveryChannel"
                                                ],
                                                "Resource": [
                                                    "*"
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "iam:PassRole"
                                                ],
                                                "Resource": [
                                                    {
                                                        "Fn::GetAtt": [
                                                            "ConfigRole",
                                                            "Arn"
                                                        ]
                                                    }
                                                ],
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "sts:AssumeRole"
                                        ],
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": [
                                                "lambda.amazonaws.com"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "ConfigBucketPermission": {
                        "Type": "AWS::Lambda::Permission",
                        "Properties": {
                            "Action": "lambda:InvokeFunction",
                            "SourceAccount": {
                                "Ref": "AWS::AccountId"
                            },
                            "Principal": "s3.amazonaws.com",
                            "FunctionName": {
                                "Ref": "BackingLambdaConfigLogProcessor"
                            },
                            "SourceArn": {
                                "Fn::GetAtt": [
                                    "ConfigurationRecorderSanitisationResults",
                                    "FinalS3BucketConfigArn"
                                ]
                            }
                        }
                    },
                    "BackingLambdaConfigLogProcessor": {
                        "Type": "AWS::Lambda::Function",
                        "Properties": {
                            "Code": {
                              "S3Bucket": { "Fn::FindInMap" : [ "BucketMap", { "Ref" : "AWS::Region" }, "BucketName"]},
                              "S3Key": "config_snapshot_logger.zip"
                            },
                            "Description": "Stream events from an AWS S3 bucket being updated by AWS config to Splunk using HTTP event collector",
                            "MemorySize": 512,
                            "Environment": {
                                "Variables": {
                                    "SPLUNK_HEC_URL": {
                                        "Ref": "SplunkHttpEventCollectorURL"
                                    },
                                    "SPLUNK_HEC_TOKEN": {
                                        "Ref": "ConfigSplunkHttpEventCollectorToken"
                                    }
                                }
                            },
                            "Handler": "index.handler",
                            "Role": {
                                "Fn::GetAtt": [
                                    "BackingLambdaExecutionConfigLogProcessorRole",
                                    "Arn"
                                ]
                            },
                            "Timeout": 300,
                            "Runtime": "nodejs6.10"
                        }
                    },
                    "BackingLambdaCloudWatchMetricsProcessor": {
                        "Type": "AWS::Lambda::Function",
                        "Properties": {
                            "Code": {
                              "S3Bucket": { "Fn::FindInMap" : [ "BucketMap", { "Ref" : "AWS::Region" }, "BucketName"]},
                              "S3Key": "splunk_metrics_poller.zip"
                            },
                            "Description": "Send CloudWatch Metrics to Splunk using HTTP event collector",
                            "MemorySize": 512,
                            "Environment": {
                                "Variables": {
                                    "SPLUNK_HEC_URL": {
                                        "Ref": "SplunkHttpEventCollectorURL"
                                    },
                                    "SPLUNK_HEC_TOKEN": {
                                        "Ref": "CloudWatchSplunkHttpEventCollectorToken"
                                    }
                                }
                            },
                            "Handler": "index.handler",
                            "Role": {
                                "Fn::GetAtt": [
                                    "BackingLambdaExecutionRoleCloudWatchMetricsProcessor",
                                    "Arn"
                                ]
                            },
                            "Timeout": 300,
                            "Runtime": "nodejs6.10"
                        }
                    },
                    "ConfigurationRecorderLambdaExecutionRole": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "ManagedPolicyArns": [
                                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                            ],
                            "Policies": [
                                {
                                    "PolicyName": "ConfigLambdaExecutionRolePolicy",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "s3:PutObject",
                                                    "s3:DeleteObject",
                                                    "s3:GetBucketPolicy",
                                                    "s3:PutBucketNotification"
                                                ],
                                                "Resource": {
                                                    "Fn::GetAtt": [
                                                        "ConfigurationRecorderSanitisationResults",
                                                        "FinalS3BucketConfigArn"
                                                    ]
                                                },
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "sts:AssumeRole"
                                        ],
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": [
                                                "lambda.amazonaws.com"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "ConfigNotificationBackupS3Bucket": {
                        "Type": "AWS::S3::Bucket",
                        "Properties": {
                            "VersioningConfiguration": {
                                "Status": "Enabled"
                            }
                        }
                    },
                    "CodeStarEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                                "source": [
                                    "aws.codestar"
                                  ],
                                  "detail-type": [
                                    "AWS API Call via CloudTrail"
                                  ],
                                  "detail": {
                                      "eventSource": [
                                          "codestar.amazonaws.com"
                                      ]
                                  }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "MigrationHubEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.migrationhub"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "migrationhub.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "AutoScalingEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.autoscaling"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "autoscaling.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudDirectoryEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.clouddirectory"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "clouddirectory.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudFormationEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.cloudformation"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "cloudformation.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudHSMEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.cloudhsm"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "cloudhsm.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudSearchEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.cloudsearch"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "cloudsearch.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudWatchEventsEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.events"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "events.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudWatchLogsEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.logs"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "logs.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CodeBuildEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.codebuild"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "codebuild.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CodeCommitEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.codecommit"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "codecommit.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CodeDeployEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.codedeploy"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "codedeploy.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CodePipelineEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.codepipeline"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "codepipeline.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CognitoUserPoolEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.cognito-idp"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "cognito-idp.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ConfigEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.config"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "config.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "DataPipelineEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.datapipeline"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "datapipeline.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "DatabaseMigrationServiceEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.dms"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "dms.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "DeviceFarmEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.devicefarm"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "devicefarm.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "DirectConnectEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.directconnect"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "directconnect.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "DirectoryServiceEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.ds"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "ds.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "DynamoDBEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.dynamodb"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "dynamodb.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "EC2EventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.ec2"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "ec2.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "EC2ContainerRegistryEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.ecr"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "ecr.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ECSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.ecs"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "ecs.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "SSMEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.ssm"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "ssm.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ElasticCacheEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.elasticache"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "elasticache.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ElasticBeanstalkEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.elasticbeanstalk"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "elasticbeanstalk.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "EFSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.elasticfilesystem"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "elasticfilesystem.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ELBEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.elasticloadbalancing"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "elasticloadbalancing.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ElasticMapReduceEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.elasticmapreduce"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "elasticmapreduce.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ElasticTranscoderEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.elastictranscoder"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "elastictranscoder.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "GuardDutyEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.guardduty"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "guardduty.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "InspectorEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.inspector"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "inspector.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ElasticsearchventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.es"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "es.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "GameLiftEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.gamelift"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "gamelift.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "GlacierEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.glacier"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "glacier.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "IoTEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.iot"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "iot.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "KMSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.kms"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "kms.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "KinesisEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.kinesis"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "kinesis.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "MonitoringEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.monitoring"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "monitoring.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "KinesisFirehoseEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.firehose"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "firehose.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "LambdaEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.lambda"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "lambda.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "MeteringMarketplaceEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.metering-marketplace"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "metering-marketplace.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "OpsWorksEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.opsworks"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "opsworks.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "OpsWorksCMEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.opsworks-cm"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "opsworks-cm.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "PollyEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.polly"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "polly.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "RedshiftEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.redshift"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "redshift.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "RDSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.rds"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "rds.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "SecretsManagerEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.secretsmanager"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "secretsmanager.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "STSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.sts"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "sts.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ServerMigrationServiceEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.sms"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "sms.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "ServiceCatalogEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.servicecatalog"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "servicecatalog.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "SESEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.ses"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "ses.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "SNSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.sns"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "sns.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "SQSEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.sqs"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "sqs.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "SWFEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.swf"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "swf.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "StepFunctionsEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.states"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "states.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "StorageGatewayEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.storagegateway"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "storagegateway.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "WAFRegionalEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.waf-regional"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "waf-regional.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "WAFEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.waf"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "waf.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "WorkDocsEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.workdocs"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "workdocs.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "WorkSpacesEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.workspaces"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "workspaces.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudTrailEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                              "source": [
                                "aws.cloudtrail"
                              ],
                              "detail-type": [
                                "AWS API Call via CloudTrail"
                              ],
                              "detail": {
                                "eventSource": [
                                  "cloudtrail.amazonaws.com"
                                ]
                              }
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "CloudTrailFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_cloudtrail_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudTrailBackupS3Bucket": {
                        "Type": "AWS::S3::Bucket",
                        "Properties": {
                            "VersioningConfiguration": {
                                "Status": "Enabled"
                            }
                        }
                    },
                    "BackingLambdaExecutionRoleCloudWatchMetricsProcessor": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "ManagedPolicyArns": [
                                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                            ],
                            "Policies": [
                                {
                                    "PolicyName": "BackingLambdaExecutionCloudWatchMetricsPolicy",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "logs:CreateLogGroup",
                                                    "logs:CreateLogStream",
                                                    "logs:PutLogEvents"
                                                ],
                                                "Resource": [
                                                    "arn:aws:logs:*:*:*"
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "lambda:UpdateFunctionConfiguration"
                                                ],
                                                "Resource": [
                                                    "*"
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "cloudwatch:GetMetricStatistics",
                                                    "cloudwatch:ListMetrics"
                                                ],
                                                "Resource": [
                                                    "*"
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "dynamodb:GetItem",
                                                    "dynamodb:UpdateItem"
                                                ],
                                                "Resource": [
                                                    "*"
                                                ],
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "sts:AssumeRole"
                                        ],
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": [
                                                "lambda.amazonaws.com"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "ConfigBucketConfiguration": {
                        "Type": "Custom::S3ConfigBucketConfiguration",
                        "Properties": {
                            "ServiceToken": {
                                "Fn::GetAtt": [
                                    "ConfigUpdateBucketConfiguration",
                                    "Arn"
                                ]
                            },
                            "Bucket": {
                                "Fn::GetAtt": [
                                    "ConfigurationRecorderSanitisationResults",
                                    "FinalS3BucketConfig"
                                ]
                            },
                            "NotificationConfiguration": {
                                "LambdaFunctionConfigurations": [
                                    {
                                        "LambdaFunctionArn": {
                                            "Fn::GetAtt": [
                                                "BackingLambdaConfigLogProcessor",
                                                "Arn"
                                            ]
                                        },
                                        "Events": [
                                            "s3:ObjectCreated:*"
                                        ]
                                    }
                                ]
                            }
                        },
                        "DependsOn": [
                            "ConfigBucketPermission"
                        ]
                    },
                    "ConfigurationRecorderSanitiser": {
                        "Type": "AWS::Lambda::Function",
                        "Properties": {
                            "Code": {
                              "S3Bucket": { "Fn::FindInMap" : [ "BucketMap", { "Ref" : "AWS::Region" }, "BucketName"]},
                              "S3Key": "config_discovery.zip"
                            },
                            "Runtime": "nodejs6.10",
                            "Handler": "index.handler",
                            "Role": {
                                "Fn::GetAtt": [
                                    "ConfigurationRecorderSanitizationLambdaExecutionRole",
                                    "Arn"
                                ]
                            },
                            "Timeout": 300
                        }
                    },
                    "EventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "State": "ENABLED",
                            "ScheduleExpression": "cron(4,9,14,19,24,29,34,39,44,49,54,59 * * * ? *)",
                            "Description": "EventRule",
                            "Targets": [
                                {
                                    "Id": "TargetFunctionMetricsPoller",
                                    "Arn": {
                                        "Fn::GetAtt": [
                                            "BackingLambdaCloudWatchMetricsProcessor",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    "CloudTrailFirehoseDeliveryPolicy": {
                        "Type": "AWS::IAM::Policy",
                        "Properties": {
                            "PolicyName": "firehose_delivery_policy",
                            "PolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "firehose:PutRecord",
                                            "firehose:PutRecordBatch"
                                        ],
                                        "Resource": [
                                           { "Fn::GetAtt" : [ "CloudTrailFirehoseDeliveryStream", "Arn" ] }
                                        ],
                                        "Effect": "Allow"
                                    }
                                ]
                            },
                            "Roles": [
                                {
                                    "Ref": "CloudTrailFirehoseDeliveryRole"
                                }
                            ]
                        }
                    },
                    "ConfigNotificationFirehoseDeliveryPolicy": {
                        "Type": "AWS::IAM::Policy",
                        "Properties": {
                            "PolicyName": "firehose_delivery_policy",
                            "PolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "firehose:PutRecord",
                                            "firehose:PutRecordBatch"
                                        ],
                                        "Resource": [
                                            { "Fn::GetAtt" : [ "ConfigNotificationFirehoseDeliveryStream", "Arn" ] }
                                        ],
                                        "Effect": "Allow"
                                    }
                                ]
                            },
                            "Roles": [
                                {
                                    "Ref": "ConfigNotificationFirehoseDeliveryRole"
                                }
                            ]
                        }
                    },
                    "ConfigNotificationFirehoseDeliveryStream": {
                        "Type": "AWS::KinesisFirehose::DeliveryStream",
                        "Properties": {
                            "SplunkDestinationConfiguration": {
                                "S3Configuration": {
                                    "CompressionFormat": "UNCOMPRESSED",
                                    "BucketARN": {
                                        "Fn::GetAtt": [
                                            "ConfigNotificationBackupS3Bucket",
                                            "Arn"
                                        ]
                                    },
                                    "RoleARN": {
                                        "Fn::GetAtt": [
                                            "ConfigNotificationBackupS3Role",
                                            "Arn"
                                        ]
                                    },
                                    "BufferingHints": {
                                        "IntervalInSeconds": 300,
                                        "SizeInMBs": 5
                                    }
                                },
                                "HECEndpointType": "Raw",
                                "HECToken": "SPLUNK_HEC_TOKEN",
                                "HECAcknowledgmentTimeoutInSeconds": 180,
                                "RetryOptions": {
                                    "DurationInSeconds": 300
                                },
                                "HECEndpoint": "SPLUNK_HEC_URL",
                                "S3BackupMode": "FailedEventsOnly",
                                "ProcessingConfiguration": {
                                    "Enabled": false
                                }
                            },
                            "DeliveryStreamType": "DirectPut",
                            "DeliveryStreamName": "splunk-config-notification-cwe-monitoring"
                        }
                    },
                    "PermissionForEventsToInvokeLambda": {
                        "Type": "AWS::Lambda::Permission",
                        "Properties": {
                            "Action": "lambda:InvokeFunction",
                            "Principal": "events.amazonaws.com",
                            "FunctionName": {
                                "Ref": "BackingLambdaCloudWatchMetricsProcessor"
                            },
                            "SourceArn": {
                                "Fn::GetAtt": [
                                    "EventRule",
                                    "Arn"
                                ]
                            }
                        }
                    },
                    "BackingLambdaExecutionConfigLogProcessor": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "ManagedPolicyArns": [
                                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                            ],
                            "Policies": [
                                {
                                    "PolicyName": "BackingLambdaExecutionCloudTrailLogProcessorPolicy",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "s3:getObject",
                                                    "s3:putObject",
                                                    "s3:ListBucket"
                                                ],
                                                "Resource": {
                                                    "Fn::Join": [
                                                        "",
                                                        [
                                                            "arn:aws:s3:::",
                                                            {
                                                                "Ref": "S3BucketConfig"
                                                            },
                                                            "/*"
                                                        ]
                                                    ]
                                                },
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "sts:AssumeRole"
                                        ],
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": [
                                                "lambda.amazonaws.com"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "ConfigUpdateBucketConfiguration": {
                        "Type": "AWS::Lambda::Function",
                        "Properties": {
                            "Code": {
                                "ZipFile": {
                                    "Fn::Sub": "var response = require('cfn-response');\nvar AWS = require('aws-sdk');\nvar s3 = new AWS.S3();\nexports.handler = function(event, context) {\n  var respond = (e) => response.send(event, context, e ? response.FAILED : response.SUCCESS, e ? e : {});\n  var params = event.ResourceProperties;\n  delete params.ServiceToken;\n  if (event.RequestType === 'Delete') {\n    params.NotificationConfiguration = {};\n    s3.putBucketNotificationConfiguration(params).promise()\n      .then((data)=>respond())\n      .catch((e)=>respond());\n  } else {\n    s3.putBucketNotificationConfiguration(params).promise()\n      .then((data)=>respond())\n      .catch((e)=>respond(e));\n  }\n};\n"
                                }
                            },
                            "Role": {
                                "Fn::GetAtt": [
                                    "ConfigurationRecorderLambdaExecutionRole",
                                    "Arn"
                                ]
                            },
                            "Description": "S3 Object Custom Resource",
                            "Timeout": 300,
                            "Handler": "index.handler",
                            "Runtime": "nodejs6.10"
                        }
                    },
                    "S3BucketConfig": {
                        "Type": "AWS::S3::Bucket",
                        "Properties": {
                            "VersioningConfiguration": {
                                "Status": "Enabled"
                            }
                        }
                    },
                    "ConfigurationRecorderSanitisationResults": {
                        "Type": "Custom::ConfigurationRecorderSanitisationResults",
                        "Properties": {
                            "S3BucketConfig": {
                                "Ref": "S3BucketConfig"
                            },
                            "RoleARN": {
                                "Fn::GetAtt": [
                                    "BackingLambdaExecutionConfigLogProcessor",
                                    "Arn"
                                ]
                            },
                            "ConfigRecorderName": "ConfigRecorder",
                            "ServiceToken": {
                                "Fn::GetAtt": [
                                    "ConfigurationRecorderSanitiser",
                                    "Arn"
                                ]
                            },
                            "S3BucketConfigArn": {
                                "Fn::GetAtt": [
                                    "S3BucketConfig",
                                    "Arn"
                                ]
                            },
                            "RecorderRoleArn": {
                                "Fn::GetAtt": [
                                    "ConfigRole",
                                    "Arn"
                                ]
                            }
                        }
                    },
                    "ConfigNotificationEventRule": {
                        "Type": "AWS::Events::Rule",
                        "Properties": {
                            "EventPattern": {
                                "source": [
                                    "aws.config"
                                ],
                                "detail-type": [
                                    "Config Configuration Item Change"
                                ]
                            },
                            "State": "ENABLED",
                            "Targets": [
                                {
                                    "RoleArn": {
                                        "Fn::GetAtt": [
                                            "ConfigNotificationFirehoseDeliveryRole",
                                            "Arn"
                                        ]
                                    },
                                    "Id": "splunk_config_notification_firehose_target",
                                    "Arn":  { "Fn::GetAtt" : [ "ConfigNotificationFirehoseDeliveryStream", "Arn" ] }
                                }
                            ]
                        }
                    },
                    "CloudTrailFirehoseDeliveryRole": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": "sts:AssumeRole",
                                        "Sid": "",
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": "events.amazonaws.com"
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "CloudTrailBackupS3Role": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "Policies": [
                                {
                                    "PolicyName": "root",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "s3:AbortMultipartUpload",
                                                    "s3:GetBucketLocation",
                                                    "s3:GetObject",
                                                    "s3:ListBucket",
                                                    "s3:ListBucketMultipartUploads",
                                                    "s3:PutObject"
                                                ],
                                                "Resource": [
                                                    {
                                                        "Fn::GetAtt": [
                                                            "CloudTrailBackupS3Bucket",
                                                            "Arn"
                                                        ]
                                                    }
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "logs:CreateLogGroup",
                                                    "logs:CreateLogStream",
                                                    "logs:PutLogEvents"
                                                ],
                                                "Resource": "*",
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": "sts:AssumeRole",
                                        "Sid": "",
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": "firehose.amazonaws.com"
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "GuardDutyFindingEventRule": {
                          "Type": "AWS::Events::Rule",
                          "Properties": {
                              "EventPattern": {
                                "source": [
                                  "aws.guardduty"
                                ],
                                "detail-type": [
                                  "GuardDuty Finding"
                                ]
                              },
                              "State": "ENABLED",
                              "Targets": [
                                  {
                                      "RoleArn": {
                                          "Fn::GetAtt": [
                                              "GuardDutyFirehoseDeliveryRole",
                                              "Arn"
                                          ]
                                      },
                                      "Id": "splunk_guardduty_notification_firehose_target",
                                      "Arn":  { "Fn::GetAtt" : [ "GuardDutyFirehoseDeliveryStream", "Arn" ] }
                                  }
                              ]
                          }
                      },
                    "GuardDutyFirehoseDeliveryStream": {
                          "Type": "AWS::KinesisFirehose::DeliveryStream",
                          "Properties": {
                              "SplunkDestinationConfiguration": {
                                  "S3Configuration": {
                                      "CompressionFormat": "UNCOMPRESSED",
                                      "BucketARN": {
                                          "Fn::GetAtt": [
                                              "GuardDutyBackupS3Bucket",
                                              "Arn"
                                          ]
                                      },
                                      "RoleARN": {
                                          "Fn::GetAtt": [
                                              "GuardDutyBackupS3Role",
                                              "Arn"
                                          ]
                                      },
                                      "BufferingHints": {
                                          "IntervalInSeconds": 300,
                                          "SizeInMBs": 5
                                      }
                                  },
                                  "HECEndpointType": "Raw",
                                  "HECToken": "SPLUNK_HEC_TOKEN",
                                  "HECAcknowledgmentTimeoutInSeconds": 180,
                                  "RetryOptions": {
                                      "DurationInSeconds": 300
                                  },
                                  "HECEndpoint": "SPLUNK_HEC_URL",
                                  "S3BackupMode": "FailedEventsOnly",
                                  "ProcessingConfiguration": {
                                      "Enabled": false
                                  }
                              },
                              "DeliveryStreamType": "DirectPut",
                              "DeliveryStreamName": "splunk-guardduty-cwe-monitoring"
                          }
                      },
                       "GuardDutyFirehoseDeliveryRole": {
                            "Type": "AWS::IAM::Role",
                            "Properties": {
                                "AssumeRolePolicyDocument": {
                                    "Version": "2012-10-17",
                                    "Statement": [
                                        {
                                            "Action": "sts:AssumeRole",
                                            "Sid": "",
                                            "Effect": "Allow",
                                            "Principal": {
                                                "Service": "events.amazonaws.com"
                                            }
                                        }
                                    ]
                                }
                            }
                        },
                      "GuardDutyFirehoseDeliveryPolicy": {
                          "Type": "AWS::IAM::Policy",
                          "Properties": {
                              "PolicyName": "firehose_delivery_policy",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Action": [
                                              "firehose:PutRecord",
                                              "firehose:PutRecordBatch"
                                          ],
                                          "Resource": [
                                              { "Fn::GetAtt" : [ "GuardDutyFirehoseDeliveryStream", "Arn" ] }
                                          ],
                                          "Effect": "Allow"
                                      }
                                  ]
                              },
                              "Roles": [
                                  {
                                      "Ref": "GuardDutyFirehoseDeliveryRole"
                                  }
                              ]
                          }
                      },
                      "GuardDutyBackupS3Bucket": {
                            "Type": "AWS::S3::Bucket",
                            "Properties": {
                                "VersioningConfiguration": {
                                    "Status": "Enabled"
                                }
                            }
                        },
                      "GuardDutyBackupS3Role": {
                          "Type": "AWS::IAM::Role",
                          "Properties": {
                              "Path": "/",
                              "Policies": [
                                  {
                                      "PolicyName": "root",
                                      "PolicyDocument": {
                                          "Version": "2012-10-17",
                                          "Statement": [
                                              {
                                                  "Action": [
                                                      "s3:AbortMultipartUpload",
                                                      "s3:GetBucketLocation",
                                                      "s3:GetObject",
                                                      "s3:ListBucket",
                                                      "s3:ListBucketMultipartUploads",
                                                      "s3:PutObject"
                                                  ],
                                                  "Resource": [
                                                      {
                                                          "Fn::GetAtt": [
                                                              "GuardDutyBackupS3Bucket",
                                                              "Arn"
                                                          ]
                                                      }
                                                  ],
                                                  "Effect": "Allow"
                                              },
                                              {
                                                  "Action": [
                                                      "logs:CreateLogGroup",
                                                      "logs:CreateLogStream",
                                                      "logs:PutLogEvents"
                                                  ],
                                                  "Resource": "*",
                                                  "Effect": "Allow"
                                              }
                                          ]
                                      }
                                  }
                              ],
                              "AssumeRolePolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Action": "sts:AssumeRole",
                                          "Sid": "",
                                          "Effect": "Allow",
                                          "Principal": {
                                              "Service": "firehose.amazonaws.com"
                                          }
                                      }
                                  ]
                              }
                          }
                    },
                    "CloudTrailFirehoseDeliveryStream": {
                        "Type": "AWS::KinesisFirehose::DeliveryStream",
                        "Properties": {
                            "SplunkDestinationConfiguration": {
                                "S3Configuration": {
                                    "CompressionFormat": "UNCOMPRESSED",
                                    "BucketARN": {
                                        "Fn::GetAtt": [
                                            "CloudTrailBackupS3Bucket",
                                            "Arn"
                                        ]
                                    },
                                    "RoleARN": {
                                        "Fn::GetAtt": [
                                            "CloudTrailBackupS3Role",
                                            "Arn"
                                        ]
                                    },
                                    "BufferingHints": {
                                        "IntervalInSeconds": 300,
                                        "SizeInMBs": 5
                                    }
                                },
                                "HECEndpointType": "Raw",
                                "HECToken": "SPLUNK_HEC_TOKEN",
                                "HECAcknowledgmentTimeoutInSeconds": 180,
                                "RetryOptions": {
                                    "DurationInSeconds": 300
                                },
                                "HECEndpoint": "SPLUNK_HEC_URL",
                                "S3BackupMode": "FailedEventsOnly",
                                "ProcessingConfiguration": {
                                    "Enabled": false
                                }
                            },
                            "DeliveryStreamType": "DirectPut",
                            "DeliveryStreamName": "splunk-cloudtrail-cwe-monitoring"
                        }
                    },
                    "ConfigRole": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "ManagedPolicyArns": [
                                "arn:aws:iam::aws:policy/service-role/AWSConfigRole"
                            ],
                            "Policies": [
                                {
                                    "PolicyName": "ConfigRolePolicy",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "s3:PutObject"
                                                ],
                                                "Resource": {
                                                    "Fn::Join": [
                                                        "",
                                                        [
                                                            "arn:aws:s3:::",
                                                            {
                                                                "Ref": "S3BucketConfig"
                                                            },
                                                            "/AWSLogs/",
                                                            {
                                                                "Ref": "AWS::AccountId"
                                                            },
                                                            "/*"
                                                        ]
                                                    ]
                                                },
                                                "Effect": "Allow",
                                                "Condition": {
                                                    "StringLike": {
                                                        "s3:x-amz-acl": "bucket-owner-full-control"
                                                    }
                                                }
                                            },
                                            {
                                                "Action": "config:Put*",
                                                "Resource": "*",
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "s3:GetBucketAcl"
                                                ],
                                                "Resource": {
                                                    "Fn::Join": [
                                                        "",
                                                        [
                                                            "arn:aws:s3:::",
                                                            {
                                                                "Ref": "S3BucketConfig"
                                                            }
                                                        ]
                                                    ]
                                                },
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": "sts:AssumeRole",
                                        "Sid": "",
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": "config.amazonaws.com"
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "TrumpetDynamoDBTable": {
                        "Type": "AWS::DynamoDB::Table",
                        "Properties": {
                            "KeySchema": [
                                {
                                    "KeyType": "HASH",
                                    "AttributeName": "metric_dimension"
                                }
                            ],
                            "TableName": "splunk_metrics_highwater",
                            "AttributeDefinitions": [
                                {
                                    "AttributeName": "metric_dimension",
                                    "AttributeType": "S"
                                }
                            ],
                            "ProvisionedThroughput": {
                                "WriteCapacityUnits": "100",
                                "ReadCapacityUnits": "100"
                            }
                        }
                    },
                    "ConfigNotificationFirehoseDeliveryRole": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": "sts:AssumeRole",
                                        "Sid": "",
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": "events.amazonaws.com"
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "BackingLambdaExecutionConfigLogProcessorRole": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "ManagedPolicyArns": [
                                "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                            ],
                            "Policies": [
                                {
                                    "PolicyName": "BackingLambdaExecutionConfigLogProcessorPolicy",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "s3:getObject",
                                                    "s3:putObject",
                                                    "s3:ListBucket"
                                                ],
                                                "Resource": {
                                                    "Fn::Join": [
                                                        "",
                                                        [
                                                            {
                                                                "Fn::GetAtt": [
                                                                    "ConfigurationRecorderSanitisationResults",
                                                                    "FinalS3BucketConfigArn"
                                                                ]
                                                            },
                                                            "/AWSLogs/",
                                                            {
                                                                "Ref": "AWS::AccountId"
                                                            },
                                                            "/*"
                                                        ]
                                                    ]
                                                },
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "sts:AssumeRole"
                                        ],
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": [
                                                "lambda.amazonaws.com"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    },
                    "ConfigNotificationBackupS3Role": {
                        "Type": "AWS::IAM::Role",
                        "Properties": {
                            "Path": "/",
                            "Policies": [
                                {
                                    "PolicyName": "root",
                                    "PolicyDocument": {
                                        "Version": "2012-10-17",
                                        "Statement": [
                                            {
                                                "Action": [
                                                    "s3:AbortMultipartUpload",
                                                    "s3:GetBucketLocation",
                                                    "s3:GetObject",
                                                    "s3:ListBucket",
                                                    "s3:ListBucketMultipartUploads",
                                                    "s3:PutObject"
                                                ],
                                                "Resource": [
                                                    {
                                                        "Fn::GetAtt": [
                                                            "ConfigNotificationBackupS3Bucket",
                                                            "Arn"
                                                        ]
                                                    }
                                                ],
                                                "Effect": "Allow"
                                            },
                                            {
                                                "Action": [
                                                    "logs:CreateLogGroup",
                                                    "logs:CreateLogStream",
                                                    "logs:PutLogEvents"
                                                ],
                                                "Resource": "*",
                                                "Effect": "Allow"
                                            }
                                        ]
                                    }
                                }
                            ],
                            "AssumeRolePolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": "sts:AssumeRole",
                                        "Sid": "",
                                        "Effect": "Allow",
                                        "Principal": {
                                            "Service": "firehose.amazonaws.com"
                                        }
                                    }
                                ]
                            }
                        }
                    }
                }
            }